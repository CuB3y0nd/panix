#!/usr/bin/env bash

set -euo pipefail

if [[ -z "${KERNEL_VERSION:-}" ]]; then
  echo "[-] KERNEL_VERSION environment variable is not set." >&2
  exit 1
fi

KERNEL_MAJOR_VERSION="${KERNEL_VERSION%%.*}"
KERNEL_MIRROR=https://cdn.kernel.org/pub/linux/kernel/v${KERNEL_MAJOR_VERSION}.x
BUSYBOX_MIRROR=https://busybox.net/downloads
DIR=linux-$KERNEL_VERSION
KERNEL_SOURCE=./downloads/linux-$KERNEL_VERSION.tar.xz
BUSYBOX_SOURCE=./downloads/busybox-$BUSYBOX_VERSION.tar.bz2

import_gpg_keys() {
  echo "[*] Importing + trusting kernel maintainers' GPG keys..."

  local GREG_FPR="647F28654894E3BD457199BE38DBBDC86092693E"
  local servers=("hkp://keyserver.ubuntu.com" "hkp://pgp.mit.edu" "hkp://keys.gnupg.net")
  local success=false

  for server in "${servers[@]}"; do
    echo "[?] Trying keyserver: $server"
    if gpg2 --keyserver "$server" --recv-keys "$GREG_FPR"; then
      success=true
      break
    fi
  done

  if [ "$success" = false ]; then
    echo "[-] Critical: Failed to import keys from all keyservers."
    echo "[!] Try running with --network=host and verified proxy settings."
    exit 1
  fi

  gpg2 --tofu-policy good "$GREG_FPR"
}

apply_kernel_patches() {
  echo "[+] Applying kernel patches..."
  sed -i 'N;s/WARN("missing symbol table");\n\t\treturn -1;/\n\t\treturn 0;\n\t\t\/\/ A missing symbol table is actually possible if its an empty .o file.  This can happen for thunk_64.o./g' \
    "$HOME/$DIR/tools/objtool/elf.c"
  sed -i 's/unsigned long __force_order/\/\/ unsigned long __force_order/g' \
    "$HOME/$DIR/arch/x86/boot/compressed/pgtable_64.c"
}

apply_busybox_patches() {
  echo "[+] Applying busybox patches..."
  sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/g' \
    "$HOME/busybox-$BUSYBOX_VERSION/.config"
}

extract_sources() {
  if [ -f "$KERNEL_SOURCE" ]; then
    echo "[*] Extracting kernel..."
    mkdir -p "$HOME/$DIR"
    tar xf "$KERNEL_SOURCE" -C "$HOME/$DIR" --strip-components=1
    apply_kernel_patches
  fi

  if [ -f "$BUSYBOX_SOURCE" ]; then
    echo "[*] Extracting busybox..."
    mkdir -p "$HOME/busybox-$BUSYBOX_VERSION"
    tar xjf "$BUSYBOX_SOURCE" -C "$HOME/busybox-$BUSYBOX_VERSION" --strip-components=1
  fi
}

build_kernel() {
  echo "[*] Generating defconfig..."
  make -C "$HOME/$DIR" defconfig

  cat >>"$HOME/$DIR/.config" <<EOF
CONFIG_NET_9P=y
CONFIG_NET_9P_DEBUG=n
CONFIG_9P_FS=y
CONFIG_9P_FS_POSIX_ACL=y
CONFIG_9P_FS_SECURITY=y
CONFIG_NET_9P_VIRTIO=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_BLK=y
CONFIG_VIRTIO_BLK_SCSI=y
CONFIG_VIRTIO_NET=y
CONFIG_VIRTIO_CONSOLE=y
CONFIG_HW_RANDOM_VIRTIO=y
CONFIG_DRM_VIRTIO_GPU=y
CONFIG_VIRTIO_PCI_LEGACY=y
CONFIG_VIRTIO_BALLOON=y
CONFIG_VIRTIO_INPUT=y
CONFIG_CRYPTO_DEV_VIRTIO=y
CONFIG_BALLOON_COMPACTION=y
CONFIG_PCI=y
CONFIG_PCI_HOST_GENERIC=y
CONFIG_GDB_SCRIPTS=y
CONFIG_DEBUG_INFO=y
CONFIG_DEBUG_INFO_REDUCED=n
CONFIG_DEBUG_INFO_SPLIT=n
CONFIG_DEBUG_FS=y
CONFIG_DEBUG_INFO_DWARF4=y
CONFIG_DEBUG_INFO_BTF=y
CONFIG_FRAME_POINTER=y
CONFIG_DEBUG_INFO_COMPRESSED_NONE=y
CONFIG_DEBUG_INFO_COMPRESSED_ZLIB=n
CONFIG_DEBUG_INFO_COMPRESSED_ZSTD=n
EOF

  echo "[*] Finalizing config with olddefconfig..."
  make -C "$HOME/$DIR" olddefconfig

  echo "[*] Building kernel..."
  make -C "$HOME/$DIR" -j"$(nproc)" bzImage
}

build_busybox() {
  echo "[*] Generating defconfig..."
  make -C "$HOME/busybox-$BUSYBOX_VERSION" defconfig

  apply_busybox_patches

  echo "[*] Building busybox..."
  make -C "$HOME/busybox-$BUSYBOX_VERSION" -j"$(nproc)"
  make -C "$HOME/busybox-$BUSYBOX_VERSION" install
}

build_filesystem() {
  echo "[*] Building filesystem..."
  mkdir -pv fs/{bin,sbin,etc,proc,sys,usr/bin,usr/sbin,root,home/panix}
  cp -a "$HOME/busybox-$BUSYBOX_VERSION/_install/"* fs/
}

case "$1" in
import_gpg_keys)
  import_gpg_keys
  ;;
extract_sources)
  extract_sources
  ;;
build_kernel)
  build_kernel
  ;;
build_busybox)
  build_busybox
  ;;
build_filesystem)
  build_filesystem
  ;;
build_all)
  build_kernel
  build_busybox
  build_filesystem
  ;;
*)
  import_gpg_keys
  extract_sources
  build_all
  ;;
esac
